@page "/plugins"
@using MUnique.OpenMU.Web.Shared.Models;
@using MUnique.OpenMU.Web.Shared.Services

@inject PlugInController _plugInController;

<PageTitle>Plugins</PageTitle>
<Breadcrumb IsFirstFromRoot="true" Caption="Plugins"/>
<h1>Plugins</h1>

<div>
    <DataTable TItem=@PlugInConfigurationViewItem>
        <TableHeader>
            <th class="col-1">Punto de Extensión</th>
            <th class="col-1">Nombre del Plugin</th>
            <th class="col-1">Tipo de Plugin</th>
            <th class="col-1">Acción</th>
        </TableHeader>
        <FilterHeader>
            <th><PlugInExtensionPointSelection SelectedPointId="@this._plugInController.PointFilter" ExtensionPoints="@this._plugInController.ExtensionPoints" OnSelectionChanged="@this.OnPlugInPointSelected" /></th>
            <th><input type="search" placeholder="Buscar" @bind="@this._plugInController.NameFilter" @bind:event="oninput"/></th>
            <th><input type="search" placeholder="Buscar" @bind="@this._plugInController.TypeFilter" @bind:event="oninput"/></th>
            <th></th>
        </FilterHeader>
        <ItemTemplate Context="item">
            <td title=@item.PlugInPointDescription>@item.PlugInPointName</td>
            <td title=@item.PlugInDescription>
                <MarkedText Marked=@this._plugInController.NameFilter Text=@item.PlugInName />
            </td>
            <td title=@item.TypeId>
                <MarkedText Marked=@this._plugInController.TypeFilter Text=@item.TypeName />
            </td>
            <td>
                @if (item.IsActive)
                {
                    <button class="btn btn-warning" @onclick="async () => await this._plugInController.DeactivateAsync(item)">Desactivar</button>
                }
                else
                {
                    <button class="btn btn-success" @onclick="async () => await this._plugInController.ActivateAsync(item)">Activar</button>
                }

                @if (item.ConfigurationType is { })
                {
                    <button class="btn btn-secondary" @onclick="() => this._plugInController.ShowPlugInConfigAsync(item)"><span class="oi oi-cog" aria-hidden="true"></span></button>
                }
            </td>
        </ItemTemplate>
        <TableFooter>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </TableFooter>
    </DataTable>
</div>

@code {
    
    private void OnPlugInPointSelected(ChangeEventArgs args)
    {
        if (args.Value is string guidString
            && Guid.TryParse(guidString, out var result))
        {
            this._plugInController.PointFilter = result;
        }
    }
}
