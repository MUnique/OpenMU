@page "/servers"

@using System.ComponentModel
@using MUnique.OpenMU.Interfaces
@using MUnique.OpenMU.Web.AdminPanel.Properties

@implements IDisposable;

<PageTitle>OpenMU: @Resources.Servers</PageTitle>
<Breadcrumb IsFirstFromRoot="true" Caption="@Resources.Servers"/>
<h1>@Resources.Servers</h1>

@if (_servers == null)
{
    <p><em>@Resources.Loading</em></p>
}
else
{
<div>
  <table>
    <thead>
    <tr>
      <th></th>
      <th class="col-sm-7">@Resources.ServerName</th>
      <th class="col-sm-1">@Resources.PlayerCount</th>
      <th class="col-sm-2">@Resources.CurrentState</th>
      <th class="col-sm-2">@Resources.Action</th>
    </tr>
    </thead>
    <tfoot>
    <TotalOnlineCounter Servers=@_servers />
    </tfoot>
    <tbody>
    @foreach (var server in this._servers.OrderBy(s => s.Type).ThenBy(s => s.Description))
    {
      <ServerItem Server=@server/>
    }
    
    <tr>
      <td></td>
      <td>
        <NavLink class="btn btn-primary" href="create-game-server">
          <span class="oi oi-plus"></span> @Resources.GameServer
        </NavLink>
        <NavLink class="btn btn-primary" href="create-connect-server">
            <span class="oi oi-plus"></span> @Resources.ConnectServer
        </NavLink>
      </td>
      <td></td>
      <td></td>
      <td>
        @if (this.ServerInstanceManager is not null)
        {
          @if (this._isRestarting)
          {
            <button type="button" class="btn-warning" disabled="disabled">
              <div class="spinner-border text-secondary" role="status">
              </div>
            </button>
          }
          else
          {
            <button type="button" class="btn-warning" @onclick="this.OnReloadAndRestartClickAsync">
              <span class="oi oi-reload"></span>
              @Resources.ReloadConfigurationAndRestartAllGameServers
            </button>
          }
        }
      </td>
    </tr>
    </tbody>
  </table>
</div>
}

@code {
    private IList<IManageableServer>? _servers;

    private bool _isRestarting;

    /// <summary>
    /// Gets or sets the <see cref="IServerProvider"/>.
    /// </summary>
    [Inject]
    public IServerProvider ServerProvider { get; set; } = null!;

    /// <summary>
    /// Gets or sets the <see cref="IGameServerInstanceManager"/>.
    /// </summary>
    [Inject]
    public IGameServerInstanceManager? ServerInstanceManager { get; set; }

    /// <inheritdoc />
    public void Dispose()
    {
        this.ServerProvider.PropertyChanged -= this.OnServersChanged;
    }

    /// <inheritdoc />
    protected override void OnInitialized()
    {
        base.OnInitialized();
        this._servers = this.ServerProvider.Servers;
        this.ServerProvider.PropertyChanged += this.OnServersChanged;
    }

    private void OnServersChanged(object? sender, PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(IServerProvider.Servers))
        {
            this._servers = this.ServerProvider.Servers;
            this.InvokeAsync(this.StateHasChanged);
        }
    }

    private async Task OnReloadAndRestartClickAsync()
    {
      this._isRestarting = true;
      try
      {
            await this.ServerInstanceManager!.RestartAllAsync(false);
      }
      finally
      {
        this._isRestarting = false;
      }
    }
}
