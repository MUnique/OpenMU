@page "/config-updates"

@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using MUnique.OpenMU.Web.Shared.Components

<PageTitle>OpenMU: Configuration Updates</PageTitle>
<Breadcrumb IsFirstFromRoot="true" Caption="Configuration Updates"/>
<h3>Configuration Updates</h3>

@if (!this.SetupService.IsInstalled || this.SetupService.IsUpdateRequired)
{
    <div class="alert alert-info" role="alert">Please, first install the database updates on the <NavLink href="setup">Setup page</NavLink>.</div>
    return;
}
@if (!this._availableUpdates.Any())
{
    <div class="alert alert-success" role="alert">No configuration data update available.</div>
    return;
}

<div class="alert alert-light">
    <p>New updates for the configuration data are available. You can select the ones which should be applied to your configuration.</p>
    <p>Mandatory updates are always applied and cannot be deselected.</p>
    <p>The updates require a restart of the server process to take effect.</p>
</div>

@foreach (var update in this._availableUpdates)
{
    <div class="card">
        <div class="card-body">
        @if (update.State == UpdateState.Started)
        {
            <div class="spinner-border text-secondary spinner-border-sm" role="status">
                <span class="sr-only">Updating...</span>
            </div>
        }
        else if (update.State == UpdateState.Failed)
        {
            <span class="oi oi-warning text-danger" aria-hidden="true"></span>
        }
        <input type="checkbox" id="@update.Version" @bind="update.Selected" />
        <label for="@update.Version">@update.Version : @update.Name</label>
        </div>
    </div>
}

<hr/>

@if (this._overallState == UpdateState.Started)
{
    <button class="btn btn-primary" type="button" disabled>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Applying updates ...
    </button>
}
else if (this._overallState == UpdateState.Failed)
{
    <button class="btn btn-primary" type="button" disabled>
        <span class="oi oi-bolt" role="status" aria-hidden="true"></span>
        Update Failed!
    </button>
}
else if (this._availableUpdates.Any(u => u.Selected))
{
    <button class="btn btn-primary" type="button" @onclick="this.OnUpdateClickAsync">Apply selected updates</button>
}
else
{
    <button class="btn btn-primary" type="button" disabled>Apply selected updates</button>
}

@if (this._exception is { } exception)
{
    <div class="alert alert-danger mt-2">
        <p>@exception.Message</p>
        <hr/>
        <span>@exception.StackTrace</span>
    </div>
}
